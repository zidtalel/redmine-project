<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Matrice des User Stories du Projet (Module > Epic > US)</title>
    <link
      rel="icon"
      type="image/jpg"
      href="../../assets/images/Redmine_icon.jpg"
    />

    <!-- Scripts de protection d'acc√®s -->
    <script src="../../assets/js/auth-guard.js"></script>
    <script src="../../assets/js/admin-guard.js"></script>
    <style>
      /* Styles g√©n√©raux */
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 20px;
        background-color: #f4f4f9;
      }
      h1 {
        border-bottom: 2px solid #ccc;
        padding-bottom: 10px;
      }
      /* Boutons de contr√¥le */
      .controls {
        margin-bottom: 20px;
      }
      .controls button {
        padding: 8px 15px;
        margin-right: 10px;
        cursor: pointer;
        background-color: #5bc0de;
        color: white;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s;
      }
      .controls button:hover {
        background-color: #31b0d5;
      }
      /* Styles des Modules (Niveau 1) */
      .toggle-module-header {
        background-color: #343a40; /* Couleur sombre principale */
        color: white;
        padding: 15px;
        margin: 15px 0 0;
        cursor: pointer;
        border-radius: 5px;
        font-size: 1.5em;
        user-select: none;
      }

      /* Styles des Epics (Niveau 2) */
      .toggle-epic-header {
        background-color: #e9ecef; /* Couleur claire secondaire */
        color: #343a40;
        padding: 10px 15px;
        margin: 10px 0 5px 20px;
        cursor: pointer;
        border-left: 5px solid #007bff;
        font-size: 1.2em;
        user-select: none;
        display: flex; /* Permet l'alignement du code/titre */
        align-items: center;
      }
      /* Style sp√©cifique pour le code de l'Epic */
      .epic-code-tag {
        font-weight: bold;
        color: #007bff; /* Bleu pour le code */
        background-color: #dbeaff;
        padding: 2px 8px;
        border-radius: 3px;
        margin-right: 15px;
        font-size: 0.9em;
        flex-shrink: 0;
      }
      /* Contenu des User Stories (Niveau 3) */
      .epic-content-list {
        list-style-type: none;
        padding-left: 40px;
        margin-top: 0;
      }

      /* Transitions et gestion de la r√©duction (Level 1 et Level 2) */
      .module-content-wrapper,
      .epic-content-list {
        transition: max-height 0.3s ease-in-out, opacity 0.3s;
        overflow: hidden;
        max-height: 5000px; /* Grande valeur pour d√©ploiement */
        opacity: 1;
      }

      /* MODULE R√âDUIT (Level 1): masque tous les Epics et US qu'il contient */
      .module-container.collapsed .module-content-wrapper {
        max-height: 0;
        opacity: 0;
        padding: 0;
        margin: 0;
      }

      /* EPIC R√âDUIT (Level 2): masque toutes les User Stories */
      .epic-container.collapsed .epic-content-list {
        max-height: 0;
        opacity: 0;
        padding: 0;
        margin: 0;
      }
      .user-story {
        background-color: white;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 5px 0 5px 20px;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95em;
      }

      /* Conteneur pour le code US et le titre US */
      .us-details-group {
        display: flex;
        align-items: center;
        /* Permet au groupe de prendre le plus d'espace possible √† gauche du tag Complexit√© */
        flex-grow: 1;
      }

      /* Style sp√©cifique pour le code de l'US */
      .us-code-tag {
        font-weight: bold;
        color: #495057; /* Gris fonc√© pour le code US */
        min-width: 100px; /* Assure un alignement visuel plus propre */
        margin-right: 10px;
        flex-shrink: 0;
        text-align: left; /* Assure l'alignement du code */
      }

      /* Style pour le titre US (qui doit rester align√© √† gauche) */
      .us-title {
        text-align: left; /* Force l'alignement √† gauche */
        flex-grow: 1; /* Permet au titre de prendre l'espace restant */
      }
      .complexity-tag {
        font-weight: bold;
        padding: 4px 10px; /* Augment√© l√©g√®rement pour le mot complet */
        border-radius: 3px;
        margin-left: 10px;
        color: white;
        font-size: 0.8em;
        flex-shrink: 0;
      }
      .c-basse {
        background-color: #28a745;
        color: white;
      }
      .c-moyenne {
        background-color: #ffc107;
        color: white;
      }
      .c-elevee {
        background-color: #dc3545;
        color: white;
      }
      .legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin: 15px 0 25px;
        font-size: 0.85em;
      }
      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .legend .chip {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        display: inline-block;
      }
      .legend .basse {
        background: #28a745;
      }
      .legend .moyenne {
        background: #ffc107;
      }
      .legend .elevee {
        background: #dc3545;
      }
      /* Ic√¥nes */
      .icon {
        display: inline-block;
        margin-right: 10px;
        transition: transform 0.2s;
      }

      /* L'ic√¥ne pointe √† droite (r√©duit) */
      .module-container.collapsed .toggle-module-header .icon,
      .epic-container.collapsed .toggle-epic-header .icon {
        transform: rotate(-90deg);
      }
      /* Lien Accueil */
      .home-link {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        font-size: 0.95em;
        font-weight: 600;
        text-decoration: none;
        color: #495057;
        padding: 8px 15px;
        border-radius: 20px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease-in-out;
      }
      .home-link:hover {
        background-color: #e9ecef;
        color: #007bff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }

      /* Footer */
      footer {
        margin-top: 50px;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      }
      footer p {
        margin: 10px 0 0 0;
        font-size: 0.8em;
        color: #000000;
        text-align: center;
      }

      /* Lien de t√©l√©chargement */
      .download-link {
        text-align: center;
        margin-top: -5px;
        margin-bottom: 20px;
      }
      .download-link a {
        display: inline-block;
        padding: 5px 10px;
        background-color: #4169e1;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.9em;
      }
      .search-bar {
        margin: 10px 0 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .search-bar input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-width: 280px;
        font-size: 0.9em;
      }
      .filter-select {
        padding: 8px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9em;
      }
      .hidden {
        display: none !important;
      }

      /* Option pour les petits √©crans (discr√©tion) */
      @media screen and (max-width: 768px) {
        .home-link {
          font-size: 0.85em;
          padding: 5px 10px;
          top: 10px;
          left: 10px;
        }
      }

      /* ================================== */
      /* === STYLES DU PANNEAU ENSEIGNANT === */
      /* ================================== */

      .admin-panel {
        margin-top: 40px;
        padding: 20px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }

      .admin-panel h3 {
        margin-top: 0;
        border-bottom: 1px solid #ccc;
        padding-bottom: 10px;
        color: #495057;
      }

      .admin-panel-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .admin-panel-controls label {
        font-weight: bold;
        color: #343a40;
      }

      .admin-panel-controls select {
        padding: 8px 12px;
        font-size: 1em;
        border-radius: 4px;
        border: 1px solid #ced4da;
      }

      .admin-panel-controls button {
        padding: 10px 20px;
        font-size: 1em;
        font-weight: bold;
        color: white;
        background-color: #28a745;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .admin-panel-controls button:hover {
        background-color: #218838;
      }

      /* Styles pour les stats dans le fichier g√©n√©r√© */
      .stats-container {
        margin-bottom: 30px;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
      }

      .stats-header {
        background-color: #e9ecef;
        color: #343a40;
        padding: 15px;
        cursor: pointer;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        font-size: 1.2em;
        font-weight: bold;
        display: flex;
        align-items: center;
      }

      .stats-content {
        padding: 20px;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        overflow: hidden;
      }

      .stats-grid {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin-bottom: 20px;
      }

      .stat-card {
        padding: 15px;
        border-radius: 5px;
        width: 30%;
        color: white;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
      }

      .stat-label {
        margin-top: 5px;
        font-size: 0.9em;
      }

      .module-color {
        background-color: #495057;
      }
      .epic-color {
        background-color: #17a2b8;
      }
      .us-color {
        background-color: #28a745;
      }

      .stats-grid-teams {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        justify-content: flex-start;
      }

      .team-card {
        padding: 12px 15px;
        border-radius: 5px;
        min-width: 150px;
        flex-grow: 1;
        text-align: center;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .team-card-label {
        font-size: 0.9em;
        opacity: 0.8;
      }

      .team-card-value {
        font-size: 1.5em;
        margin-top: 5px;
        line-height: 1;
      }

      .complexity-summary-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .complexity-card {
        padding: 12px 15px;
        border-radius: 5px;
        min-width: 150px;
        flex-grow: 1;
        text-align: center;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .complexity-card.c1 {
        background-color: #20c997;
      }
      .complexity-card.c2 {
        background-color: #fd7e14;
      }

      .complexity-card-value {
        font-size: 1.4em;
        line-height: 1;
      }

      .complexity-card-label {
        font-size: 0.8em;
        margin-top: 4px;
        opacity: 0.9;
      }

      .team-tag {
        font-weight: bold;
        padding: 4px 10px;
        border-radius: 3px;
        margin-left: 10px;
        background-color: #007bff;
        color: white;
        font-size: 0.8em;
        flex-shrink: 0;
      }

      .filters-bar {
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }

      .filters-bar strong {
        margin-right: 10px;
        flex-shrink: 0;
      }

      .filters-bar button {
        padding: 8px 15px;
        margin-right: 10px;
        cursor: pointer;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s;
      }

      .filters-bar button:hover {
        background-color: #5a6268;
      }

      .filters-bar button.active {
        background-color: #007bff;
      }

      .filters-bar select {
        background-color: white;
        color: #333;
        border: 1px solid #ccc;
        height: 35px;
        min-width: 130px;
        padding: 5px 10px;
        border-radius: 4px;
      }

      #export-csv-btn {
        background-color: #ffc107;
        color: black;
        font-weight: bold;
        margin-left: auto;
      }

      .user-story.hidden-by-filter,
      .user-story.hidden-by-search {
        display: none;
      }

      .module-container.hidden-by-search,
      .epic-container.hidden-by-search {
        display: none;
      }
    </style>
  </head>
  <body>
    <a
      href="../main/menu.html"
      class="home-link"
      title="Retour √† la page d'accueil"
    >
      üè† Accueil
    </a>

    <center>
      <h1>Matrice des User Stories du Projet (Module > Epic > US)</h1>
    </center>

    <p class="download-link">
      <a
        href="../../docs/csv/RepartitionRedmine.csv"
        download="RepartitionRedmine.csv"
        title="T√©l√©charger la matrice des US en format CSV"
      >
        ‚¨áÔ∏è T√©l√©charger la matrice des US (CSV)
      </a>
    </p>

    <div class="controls">
      <button onclick="collapseAllEpics()">R√©duire toutes les US</button>
      <button onclick="collapseAllModules()">R√©duire tous les Epics/US</button>
      <button onclick="expandAll()">D√©ployer Tout</button>
    </div>

    <div class="legend">
      <span><span class="chip basse"></span>Complexit√© Basse</span>
      <span><span class="chip moyenne"></span>Complexit√© Moyenne</span>
      <span><span class="chip elevee"></span>Complexit√© √âlev√©e</span>
    </div>
    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Recherche (code ou texte)"
      />
      <select id="complexityFilter" class="filter-select">
        <option value="all">Toutes complexit√©s</option>
        <option value="Basse">Basse</option>
        <option value="Moyenne">Moyenne</option>
        <option value="√âlev√©e">√âlev√©e</option>
      </select>
    </div>

    <div class="hierarchy-container" id="hierarchyContainer"></div>
    <div
      id="loadError"
      class="hidden"
      style="
        color: #842029;
        background: #f8d7da;
        border: 1px solid #f5c2c7;
        padding: 8px 10px;
        border-radius: 4px;
        margin-top: 10px;
      "
    ></div>

    <div class="admin-panel">
      <h3>Panneau Enseignant (G√©n√©rateur)</h3>
      <p>
        Cet outil g√©n√®re un fichier HTML statique avec la r√©partition des US
        calcul√©e. Ce panneau ne sera pas visible par les √©tudiants dans le
        fichier g√©n√©r√©.
      </p>
      <div class="admin-panel-controls">
        <label for="team-count-select">Nombre d'√©quipes :</label>
        <select id="team-count-select">
          <option value="0">Choisir...</option>
          <option value="2">2 √âquipes</option>
          <option value="3">3 √âquipes</option>
          <option value="4">4 √âquipes</option>
          <option value="5">5 √âquipes</option>
        </select>
        <button id="generate-button">G√©n√©rer et T√©l√©charger le Fichier</button>
      </div>
    </div>

    <footer>
      <center>
        <p>
          &copy; Talel Zid | Version 1.0 ‚Äî Novembre 2024 |
          <a href="https://www.redmine.org/" target="_blank"
            >Redmine Project Management</a
          >
          | <br />Pour usage personnel ou √©ducatif seulement.
        </p>
      </center>
    </footer>

    <script>
      const CSV_URL = "../../docs/csv/RepartitionRedmine.csv";

      // Lecture du CSV puis rendu int√©gral depuis la source unique
      async function loadAndRender() {
        try {
          const res = await fetch(CSV_URL, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          const rows = parseCSV(text);
          render(rows);
          applyFilters();
        } catch (err) {
          const box = document.getElementById("loadError");
          box.textContent = `Erreur de chargement du CSV (${CSV_URL}) : ${err.message}. Si vous ouvrez le fichier en file://, utilisez un serveur local.`;
          box.classList.remove("hidden");
        }
      }

      // Parseur simple CSV √† s√©parateur ';' (attendu par le fichier)
      function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        const rows = [];
        for (let i = 0; i < lines.length; i++) {
          const cols = lines[i]
            .split(";")
            .map((c) => c.replace(/\r/g, "").trim());
          if (i === 0) continue; // sauter l'en-t√™te
          if (cols.length < 6) continue; // ignorer lignes incompl√®tes
          const [mCode, mName, eCode, eName, usCode, usTitle] = cols;
          const rawComplexity = cols[6] || "";
          rows.push([
            mCode,
            mName,
            eCode,
            eName,
            usCode,
            usTitle,
            normalizeComplexity(rawComplexity),
          ]);
        }
        return rows;
      }

      // --- Groupement hi√©rarchique ---
      function buildHierarchy(rows) {
        const modules = new Map();
        rows.forEach(([mCode, mName, eCode, eName, usCode, usTitle, comp]) => {
          if (!modules.has(mCode))
            modules.set(mCode, {
              code: mCode,
              name: mName,
              epics: new Map(),
            });
          const mod = modules.get(mCode);
          if (!mod.epics.has(eCode))
            mod.epics.set(eCode, {
              code: eCode,
              name: eName,
              stories: [],
            });
          mod.epics.get(eCode).stories.push({
            code: usCode,
            title: usTitle,
            complexity: comp,
          });
        });
        return Array.from(modules.values()).map((m) => ({
          ...m,
          epics: Array.from(m.epics.values()),
        }));
      }

      function normalizeComplexity(raw) {
        const l = (raw || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/\p{Diacritic}/gu, "");
        if (l.includes("elevee") || l.includes("elev") || l.includes("lev"))
          return "√âlev√©e";
        if (l.includes("moy")) return "Moyenne";
        return "Basse";
      }

      function complexityClass(label) {
        const l = (label || "").toLowerCase();
        if (l.includes("lev")) return "c-elevee";
        if (l.startsWith("m")) return "c-moyenne";
        return "c-basse";
      }

      function render(rows) {
        const container = document.getElementById("hierarchyContainer");
        container.innerHTML = "";
        const data = buildHierarchy(rows);
        data.forEach((module) => {
          const modDiv = document.createElement("div");
          modDiv.className = "module-container expanded";
          modDiv.innerHTML = `<h2 class="toggle-module-header"><span class="icon">‚ñº</span>${module.code} : ${module.name}</h2><div class="module-content-wrapper"></div>`;
          const wrapper = modDiv.querySelector(".module-content-wrapper");
          module.epics.forEach((epic) => {
            const epicDiv = document.createElement("div");
            epicDiv.className = "epic-container expanded";
            epicDiv.innerHTML = `<h3 class="toggle-epic-header"><span class="icon">‚ñº</span><span class="epic-code-tag">${epic.code}</span>${epic.name}</h3><ul class="epic-content-list"></ul>`;
            const list = epicDiv.querySelector("ul");
            epic.stories.forEach((story) => {
              const li = document.createElement("li");
              li.className = "user-story";
              li.dataset.module = module.code;
              li.dataset.epic = epic.code;
              li.dataset.complexity = story.complexity;
              li.innerHTML = `<div class="us-details-group"><span class="us-code-tag">${
                story.code
              }</span><span class="us-title">${
                story.title
              }</span></div><span class="complexity-tag ${complexityClass(
                story.complexity
              )}">${story.complexity}</span>`;
              list.appendChild(li);
            });
            wrapper.appendChild(epicDiv);
          });
          container.appendChild(modDiv);
        });
        attachToggleHandlers();
      }

      function attachToggleHandlers() {
        document.querySelectorAll(".toggle-module-header").forEach((h) => {
          h.onclick = () => h.parentElement.classList.toggle("collapsed");
        });
        document.querySelectorAll(".toggle-epic-header").forEach((h) => {
          h.onclick = () => h.parentElement.classList.toggle("collapsed");
        });
      }

      function expandAll() {
        document
          .querySelectorAll(".module-container, .epic-container")
          .forEach((e) => e.classList.remove("collapsed"));
      }
      function collapseAllModules() {
        document
          .querySelectorAll(".module-container")
          .forEach((e) => e.classList.add("collapsed"));
      }
      function collapseAllEpics() {
        document
          .querySelectorAll(".epic-container")
          .forEach((e) => e.classList.add("collapsed"));
        document
          .querySelectorAll(".module-container")
          .forEach((e) => e.classList.remove("collapsed"));
      }

      // --- Recherche & Filtre complexit√© ---
      function applyFilters() {
        const q = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        const comp = document.getElementById("complexityFilter").value;
        const stories = document.querySelectorAll(".user-story");
        stories.forEach((story) => {
          const text = (story.textContent || "").toLowerCase();
          const matchesQ = !q || text.includes(q);
          const matchesC = comp === "all" || story.dataset.complexity === comp;
          story.classList.toggle("hidden", !(matchesQ && matchesC));
        });
        // Masquer epics ou modules vides
        document.querySelectorAll(".epic-container").forEach((ep) => {
          const hasVisible =
            ep.querySelectorAll(".user-story:not(.hidden)").length > 0;
          ep.classList.toggle("hidden", !hasVisible);
        });
        document.querySelectorAll(".module-container").forEach((mod) => {
          const hasVisible =
            mod.querySelectorAll(".user-story:not(.hidden)").length > 0;
          mod.classList.toggle("hidden", !hasVisible);
        });
      }

      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);
      document
        .getElementById("complexityFilter")
        .addEventListener("change", applyFilters);

      // ==========================================================
      // === FONCTIONS DU G√âN√âRATEUR (PANNEAU ENSEIGNANT) ===
      // ==========================================================

      /** D√©termine le libell√© standard de complexit√©: Basse | Moyenne | √âlev√©e */
      function complexityToLabel(complexityText) {
        const l = (complexityText || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/\p{Diacritic}/gu, "");
        if (l.includes("elevee") || l.includes("elev")) return "√âlev√©e";
        if (l.includes("moy")) return "Moyenne";
        return "Basse";
      }

      /** Poids pour la charge: Basse=1, Moyenne=2, √âlev√©e=3 */
      function complexityWeight(label) {
        const l = (label || "").toLowerCase();
        if (l.includes("lev")) return 3;
        if (l.startsWith("m")) return 2;
        return 1;
      }

      /** Injecte le CSS n√©cessaire dans le <head> du document clon√© */
      function injectCSS(doc) {
        const style = document.createElement("style");
        style.type = "text/css";
        style.innerHTML = `
            .team-tag {
                font-weight: bold;
                padding: 4px 10px;
                border-radius: 3px;
                margin-left: 10px;
                background-color: #007bff; 
                color: white;
                font-size: 0.8em;
                flex-shrink: 0;
            }
            
            .filters-bar {
                margin-bottom: 20px;
                padding: 10px;
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 5px;
                display: flex; 
                align-items: center;
                flex-wrap: wrap; 
            }
            .filters-bar strong {
                margin-right: 10px;
                flex-shrink: 0;
            }
            .filters-bar button, .filters-bar select {
                padding: 8px 15px;
                margin-right: 10px;
                cursor: pointer;
                background-color: #6c757d; 
                color: white;
                border: none;
                border-radius: 4px;
                transition: background-color 0.3s;
            }
            .filters-bar button:hover {
                background-color: #5a6268;
            }
            .filters-bar button.active {
                background-color: #007bff; 
            }
            #export-csv-btn {
                background-color: #ffc107; 
                color: black;
                font-weight: bold;
                margin-left: auto; 
            }
            .filters-bar select {
                background-color: white;
                color: #333;
                border: 1px solid #ccc;
                height: 35px; 
                min-width: 130px;
            }

            .user-story.hidden-by-filter,
            .user-story.hidden-by-search {
                display: none;
            }
            
            .stats-container {
                margin-bottom: 30px;
                background-color: #ffffff;
                border: 1px solid #dee2e6;
                border-radius: 8px;
            }
            
            .stats-header {
                background-color: #e9ecef;
                color: #343a40;
                padding: 15px;
                cursor: pointer;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                font-size: 1.2em;
                font-weight: bold;
                display: flex;
                align-items: center;
            }
            
            .stats-header .icon {
                margin-right: 10px;
            }

            .stats-content {
                padding: 20px;
                transition: max-height 0.3s ease-out, padding 0.3s ease-out;
                overflow: hidden;
            }
            
            .stats-container.collapsed .stats-content {
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            .stats-container.collapsed .stats-header {
                border-radius: 8px; 
            }
            .stats-container.collapsed .stats-header .icon::before {
                content: '‚ñ∫'; 
            }
            
            .stats-header .icon::before {
                content: '‚ñº'; 
            }
            
            .stats-grid {
                display: flex;
                justify-content: space-around;
                text-align: center;
                margin-bottom: 20px;
            }
            .stat-card {
                padding: 15px;
                border-radius: 5px;
                width: 30%;
                color: white;
            }
            .stat-value {
                font-size: 2em;
                font-weight: bold;
            }
            
            .module-color { background-color: #495057; }
            .epic-color { background-color: #17a2b8; }
            .us-color { background-color: #28a745; }
            
            .stats-grid-teams {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 20px;
                justify-content: flex-start;
            }
            
            .team-card {
                padding: 12px 15px;
                border-radius: 5px;
                min-width: 150px;
                flex-grow: 1;
                text-align: center;
                color: white;
                font-weight: bold;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .team-card-label {
                font-size: 0.9em;
                opacity: 0.8;
            }
            .team-card-value {
                font-size: 1.5em;
                margin-top: 5px;
                line-height: 1;
            }
            
            .complexity-summary-cards {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }
            .complexity-card {
                padding: 12px 15px;
                border-radius: 5px;
                min-width: 150px;
                flex-grow: 1;
                text-align: center;
                color: white;
                font-weight: bold;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .complexity-card.c1 { background-color: #20c997; }
            .complexity-card.c2 { background-color: #fd7e14; }
            
            .complexity-card-value {
                font-size: 1.4em;
                line-height: 1;
            }
            .complexity-card-label {
                font-size: 0.8em;
                margin-top: 4px;
                opacity: 0.9;
            }
            
            .module-container.hidden-by-search,
            .epic-container.hidden-by-search {
                display: none;
            }
        `;
        doc.head.appendChild(style);
      }

      /** Injecte les statistiques dans le document clon√© */
      function injectStatsHTML(doc, stats, getStatsHTML) {
        const controlsDiv = doc.querySelector(".controls");
        if (!controlsDiv) return;

        const statsContainer = document.createElement("div");
        statsContainer.className = "stats-container";
        statsContainer.classList.add("collapsed");
        statsContainer.innerHTML = getStatsHTML(stats);
        controlsDiv.insertAdjacentElement("afterend", statsContainer);
      }

      /** Injecte les filtres (√©quipe, complexit√©) */
      function injectFiltersHTML(doc, numTeams) {
        const statsContainer = doc.querySelector(".stats-container");
        if (!statsContainer) return;

        const filtersBar = document.createElement("div");
        filtersBar.className = "filters-bar";

        let html = "<strong>√âquipe :</strong> ";
        html += '<button id="filter-btn-team-all" class="active">Tout</button>';

        for (let i = 1; i <= numTeams; i++) {
          html += `<button id="filter-btn-team-${i}">√âquipe ${i}</button>`;
        }

        html += '<strong style="margin-left: 20px;">Complexit√© :</strong> ';
        html += `
      <select id="complexity-select-filter">
        <option value="all">Tout</option>
        <option value="Basse">Basse</option>
        <option value="Moyenne">Moyenne</option>
        <option value="√âlev√©e">√âlev√©e</option>
      </select>
    `;

        html += `<button id="export-csv-btn">Exporter en CSV</button>`;
        filtersBar.innerHTML = html;
        statsContainer.insertAdjacentElement("afterend", filtersBar);
      }

      /** Injecte les fonctions de filtrage et d'export CSV */
      function injectFiltersJS(doc) {
        const newScript = document.createElement("script");

        const filterAndExportCode = `
            function applyCombinedFilters(silent = false) {
                const stories = document.querySelectorAll('.user-story');
                
                const activeTeamBtn = document.querySelector('.filters-bar button[id^="filter-btn-team-"].active');
                const teamFilter = activeTeamBtn ? (activeTeamBtn.id.includes('all') ? 'all' : activeTeamBtn.id.replace('filter-btn-team-', '')) : 'all';
                
                const complexitySelect = document.getElementById('complexity-select-filter');
                const complexityFilter = complexitySelect ? complexitySelect.value : 'all';

                stories.forEach(story => {
                    const teamMatch = teamFilter === 'all' || story.dataset.team === teamFilter;
                    const complexityMatch = complexityFilter === 'all' || story.dataset.complexity === complexityFilter;
                    story.classList.toggle('hidden-by-filter', !(teamMatch && complexityMatch));
                });
                
                document.querySelectorAll('.epic-container').forEach(ep => {
                    const hasVisible = ep.querySelectorAll('.user-story:not(.hidden-by-filter)').length > 0;
                    ep.classList.toggle('hidden-by-filter', !hasVisible);
                });
                document.querySelectorAll('.module-container').forEach(mod => {
                    const hasVisible = mod.querySelectorAll('.user-story:not(.hidden-by-filter)').length > 0;
                    mod.classList.toggle('hidden-by-filter', !hasVisible);
                });
                
                if (!silent) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            function attachFilterListeners() {
                const teamButtons = document.querySelectorAll('.filters-bar button[id^="filter-btn-team-"]:not(#export-csv-btn)');
                teamButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.filters-bar button[id^="filter-btn-team-"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        applyCombinedFilters();
                    });
                });
                
                document.getElementById('complexity-select-filter')?.addEventListener('change', applyCombinedFilters);

                document.querySelector('.stats-container .stats-header')?.addEventListener('click', (event) => {
                    event.currentTarget.closest('.stats-container').classList.toggle('collapsed');
                });

                const csvBtn = document.getElementById('export-csv-btn');
                if(csvBtn) {
                    csvBtn.addEventListener('click', exportToCSV);
                }

                document.querySelectorAll('.toggle-module-header').forEach(h => {
                    h.onclick = () => h.parentElement.classList.toggle('collapsed');
                });
                document.querySelectorAll('.toggle-epic-header').forEach(h => {
                    h.onclick = () => h.parentElement.classList.toggle('collapsed');
                });
            }

            function exportToCSV() {
                let csv = "Code module;Module;Code Epic;Epic;Code US;US;√âquipe;Complexit√©\\r\\n";
                
                const visibleStories = document.querySelectorAll('.user-story:not(.hidden-by-filter)');

                if (visibleStories.length === 0) {
                    alert("Aucune User Story visible √† exporter.");
                    return;
                }
                
                visibleStories.forEach(story => {
                    const cleanText = (text) => text ? text.trim().replace(/"/g, '""') : '';
                    
                    const moduleContainer = story.closest('.module-container');
                    const moduleHeader = moduleContainer ? moduleContainer.querySelector('.toggle-module-header').textContent : '';
                    const moduleMatch = moduleHeader.match(/([A-Z]+\\d+)\\s*:\\s*(.+)/);
                    const moduleCode = moduleMatch ? moduleMatch[1].trim() : '';
                    const moduleName = moduleMatch ? moduleMatch[2].trim() : '';
                    
                    const epicContainer = story.closest('.epic-container');
                    const epicCodeTag = epicContainer ? epicContainer.querySelector('.epic-code-tag') : null;
                    const epicHeader = epicContainer ? epicContainer.querySelector('.toggle-epic-header') : null;
                    const epicCode = epicCodeTag ? epicCodeTag.textContent.trim() : '';
                    const epicName = epicHeader ? epicHeader.textContent.replace(epicCode, '').replace(/[‚ñº‚ñ∫]/g, '').trim() : '';
                    
                    const usCodeTag = story.querySelector('.us-code-tag');
                    const usTitleTag = story.querySelector('.us-title');
                    const usCode = usCodeTag ? usCodeTag.textContent.trim() : '';
                    const usDescription = usTitleTag ? usTitleTag.textContent.trim() : '';
                    
                    const teamNumber = story.dataset.team || 'N/A';
                    const complexity = story.dataset.complexity || '';
                    
                    const line = [
                        cleanText(moduleCode),
                        cleanText(moduleName),
                        cleanText(epicCode),
                        cleanText(epicName),
                        cleanText(usCode),
                        cleanText(usDescription),
                        '√âquipe ' + teamNumber,
                        'Complexit√© ' + complexity
                    ].join(';');
                    
                    csv += line + "\\r\\n";
                });

                const filename = 'export_us_repartition.csv';
                const blob = new Blob(["\\uFEFF" + csv], { type: 'text/csv;charset=utf-8' });

                const link = document.createElement("a");
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert("Votre navigateur ne supporte pas le t√©l√©chargement automatique de fichiers.");
                }
            }
            
            attachFilterListeners();
        `;

        newScript.textContent = filterAndExportCode;
        doc.body.appendChild(newScript);
      }

      /** Fonction principale pour g√©n√©rer le fichier de r√©partition */
      async function generateAndDownload() {
        const numTeams = parseInt(
          document.getElementById("team-count-select").value,
          10
        );
        if (numTeams === 0) {
          alert("Veuillez s√©lectionner un nombre d'√©quipes.");
          return;
        }

        const newDoc = document.cloneNode(true);

        // 1. CALCUL DES STATS GLOBALES ET CHARGE DE TRAVAIL
        const allStories = Array.from(newDoc.querySelectorAll(".user-story"));
        const totalStories = allStories.length;
        const totalModules =
          newDoc.querySelectorAll(".module-container").length;
        const totalEpics = newDoc.querySelectorAll(".epic-container").length;

        const storiesByComplexity = { Basse: [], Moyenne: [], √âlev√©e: [] };
        let complexityBasseCount = 0;
        let complexityMoyenneCount = 0;
        let complexityEleveeCount = 0;

        allStories.forEach((story) => {
          const complexityTag = story.querySelector(".complexity-tag");
          if (complexityTag) {
            const complexityText = complexityTag.textContent;
            const label = complexityToLabel(complexityText);
            if (label === "Basse") {
              storiesByComplexity.Basse.push(story);
              complexityBasseCount++;
            } else if (label === "Moyenne") {
              storiesByComplexity.Moyenne.push(story);
              complexityMoyenneCount++;
            } else {
              storiesByComplexity["√âlev√©e"].push(story);
              complexityEleveeCount++;
            }
            story.dataset.complexity = label;
          }
        });

        const teamWorkload = {};
        for (let i = 1; i <= numTeams; i++) {
          teamWorkload[i] = { count: 0, complexity: 0 };
        }

        const shuffleArray = (array) => {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
        };

        // 2. DISTRIBUTION AVEC MISE √Ä JOUR DE LA CHARGE DE TRAVAIL
        const distributeAndCalculate = (stories, complexityValue) => {
          shuffleArray(stories);

          stories.forEach((story, index) => {
            const teamNumber = (index % numTeams) + 1;
            story.dataset.team = teamNumber;

            const teamTag = document.createElement("span");
            teamTag.className = "team-tag";
            teamTag.textContent = `√âquipe ${teamNumber}`;
            story.appendChild(teamTag);

            teamWorkload[teamNumber].count++;
            teamWorkload[teamNumber].complexity += complexityValue;
          });
        };

        distributeAndCalculate(
          storiesByComplexity.Basse,
          complexityWeight("Basse")
        );
        distributeAndCalculate(
          storiesByComplexity.Moyenne,
          complexityWeight("Moyenne")
        );
        distributeAndCalculate(
          storiesByComplexity["√âlev√©e"],
          complexityWeight("√âlev√©e")
        );

        // 3. ENCAPSULATION ET G√âN√âRATION DES STATS HTML
        const stats = {
          totalStories,
          totalModules,
          totalEpics,
          complexityBasseCount,
          complexityMoyenneCount,
          complexityEleveeCount,
          teamWorkload,
          numTeams,
        };

        const getStatsHTML = (stats) => {
          let html = `
            <div class="stats-header">
                <span class="icon"></span> Statistiques du Projet et R√©partition (${
                  stats.numTeams
                } √âquipes)
            </div>
            <div class="stats-content">
                <div class="stats-grid">
                    <div class="stat-card module-color">
                        <div class="stat-value">${stats.totalModules}</div>
                        <div class="stat-label">Modules</div>
                    </div>
                    <div class="stat-card epic-color">
                        <div class="stat-value">${stats.totalEpics}</div>
                        <div class="stat-label">Epics</div>
                    </div>
                    <div class="stat-card us-color">
                        <div class="stat-value">${stats.totalStories}</div>
                        <div class="stat-label">User Stories</div>
                    </div>
                </div>
                
                <h3>Complexit√© Totale (R√©partition)</h3>
                <div class="complexity-summary-cards">
                    <div class="complexity-card c1">
                        <div class="complexity-card-value">${
                          stats.complexityBasseCount
                        } US</div>
                        <div class="complexity-card-label">Basse (${(
                          (stats.complexityBasseCount / stats.totalStories) *
                          100
                        ).toFixed(1)}%)</div>
                    </div>
                    <div class="complexity-card c2">
                        <div class="complexity-card-value">${
                          stats.complexityMoyenneCount
                        } US</div>
                        <div class="complexity-card-label">Moyenne (${(
                          (stats.complexityMoyenneCount / stats.totalStories) *
                          100
                        ).toFixed(1)}%)</div>
                    </div>
                    <div class="complexity-card" style="background-color:#dc3545;">
                        <div class="complexity-card-value">${
                          stats.complexityEleveeCount
                        } US</div>
                        <div class="complexity-card-label">√âlev√©e (${(
                          (stats.complexityEleveeCount / stats.totalStories) *
                          100
                        ).toFixed(1)}%)</div>
                    </div>
                </div>

                <h3>Charge de Travail par √âquipe (Pts Complexit√© / US)</h3>
                <div class="stats-grid-teams">`;

          for (let i = 1; i <= stats.numTeams; i++) {
            const wl = stats.teamWorkload[i];
            const dynamicColor = `hsl(${(i * 360) / stats.numTeams}, 70%, 50%)`;

            html += `
                    <div class="team-card" style="background-color: ${dynamicColor};">
                        <div class="team-card-label">√âquipe ${i}</div>
                        <div class="team-card-value">${wl.complexity} pts / ${wl.count} US</div>
                    </div>`;
          }

          html += `</div>
            </div>
            `;

          return html;
        };

        // 4. INJECTION DANS LE DOCUMENT CLON√â
        injectCSS(newDoc);
        injectStatsHTML(newDoc, stats, getStatsHTML);
        injectFiltersHTML(newDoc, numTeams);
        injectFiltersJS(newDoc);

        // Retrait du panneau admin et de la barre de recherche originale
        const adminPanel = newDoc.querySelector(".admin-panel");
        if (adminPanel) {
          adminPanel.remove();
        }
        const searchBar = newDoc.querySelector(".search-bar");
        if (searchBar) {
          searchBar.remove();
        }

        // S√©rialisation et t√©l√©chargement
        const finalHtml =
          "<!DOCTYPE html>\n" + newDoc.documentElement.outerHTML;
        const blob = new Blob([finalHtml], { type: "text/html;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `features_${numTeams}_equipes.html`;
        link.click();

        alert(
          `Fichier features_${numTeams}_equipes.html g√©n√©r√© avec succ√®s!\n\n` +
            `Total: ${totalStories} US r√©parties sur ${numTeams} √©quipes.\n` +
            `Basse: ${complexityBasseCount} US\n` +
            `Moyenne: ${complexityMoyenneCount} US\n` +
            `√âlev√©e: ${complexityEleveeCount} US`
        );
      }

      // Attacher le gestionnaire au bouton de g√©n√©ration
      document.addEventListener("DOMContentLoaded", () => {
        const generateButton = document.getElementById("generate-button");
        if (generateButton) {
          generateButton.addEventListener("click", generateAndDownload);
        }
      });

      // Chargement initial depuis le CSV
      loadAndRender();
    </script>
  </body>
</html>
